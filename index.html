<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Govt. ITI Nagpur - Short Term Courses Portal</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: #f5f7fa; 
      color: #333;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .login-container { 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      min-height: 100vh; 
      background: linear-gradient(135deg, #0044cc 0%, #002a80 100%); 
      padding: 20px; 
    }
    
    .login-box { 
      background: white; 
      padding: 50px 40px; 
      border-radius: 20px; 
      box-shadow: 0 20px 60px rgba(0,0,0,0.3); 
      width: 100%; 
      max-width: 450px; 
    }
    
    .login-header {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .login-logo {
      width: 80px;
      height: 80px;
      object-fit: contain;
      border-radius: 8px;
      padding: 5px;
      background: #f9f9f9;
    }
    
    .login-box h1 { 
      text-align: center; 
      color: #0044cc; 
      margin-bottom: 8px; 
      font-size: 28px;
      font-weight: 700;
    }
    
    .login-box .subtitle { 
      text-align: center; 
      color: #000; 
      margin-bottom: 35px; 
      font-size: 15px;
      font-weight: 600;
    }
    
    .form-group { margin-bottom: 25px; position: relative; }
    .form-group label { display: block; margin-bottom: 8px; color: #444; font-weight: 600; font-size: 14px; }
    .form-group input { width: 100%; padding: 14px 16px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 15px; transition: all 0.3s; }
    .form-group input:focus { outline: none; border-color: #0044cc; box-shadow: 0 0 0 3px rgba(0,68,204,0.1); }
    
    .password-toggle {
      position: absolute;
      right: 15px;
      top: 43px;
      cursor: pointer;
      color: #666;
      font-size: 18px;
      user-select: none;
    }
    
    .password-toggle:hover { color: #0044cc; }
    
    .btn-primary { width: 100%; padding: 16px; background: linear-gradient(135deg, #0044cc, #0066ff); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(0,68,204,0.4); }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    
    .login-footer {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 2px solid #e0e0e0;
      text-align: center;
    }
    
    .login-footer p {
      font-size: 13px;
      color: #666;
      margin: 8px 0;
    }
    
    .login-footer .developer {
      color: #0044cc;
      font-weight: 600;
      font-size: 14px;
    }
    
    .login-footer .contact {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    
    .login-footer .contact a {
      color: #0066ff;
      text-decoration: none;
      font-size: 12px;
      padding: 6px 12px;
      background: #e3f2fd;
      border-radius: 6px;
      transition: all 0.3s;
    }
    
    .login-footer .contact a:hover {
      background: #bbdefb;
      transform: translateY(-2px);
    }
    
    .icon-instruction {
      margin-top: 15px;
      padding: 15px;
      background: #f0f9ff;
      border-radius: 8px;
      border-left: 3px solid #0044cc;
      font-size: 11px;
      color: #0044cc;
      line-height: 1.6;
    }
    
    .icon-instruction strong {
      display: block;
      margin-bottom: 5px;
      font-size: 12px;
    }
    
    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #ffffff;
      border-top: 2px solid transparent;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      margin-right: 8px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .app { 
      display: none; 
      flex: 1;
      flex-direction: column;
    }
    
    .header { 
      background: linear-gradient(135deg, #0044cc 0%, #002a80 100%); 
      color: white; 
      padding: 20px 0; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
    }
    
    .header-content { 
      max-width: 1400px; 
      margin: 0 auto; 
      padding: 0 20px; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      flex-wrap: wrap; 
    }
    
    .logo-section { 
      display: flex; 
      align-items: center; 
      gap: 15px; 
    }
    
    .logo-small { 
      width: 55px; 
      height: 55px; 
      object-fit: contain;
      background: white;
      padding: 5px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.3);
    }
    
    .brand-text h1 { font-size: 22px; margin-bottom: 3px; }
    .brand-text p { font-size: 12px; opacity: 0.9; }
    .user-info { display: flex; align-items: center; gap: 15px; }
    .user-name { font-weight: 600; font-size: 15px; }
    .btn-logout { background: rgba(255,255,255,0.2); padding: 10px 20px; border-radius: 8px; border: none; color: white; cursor: pointer; font-size: 14px; transition: all 0.3s; }
    .btn-logout:hover { background: rgba(255,255,255,0.3); }
    
    .main-content { 
      flex: 1;
      max-width: 1400px; 
      margin: 0 auto; 
      padding: 30px 20px 80px 20px; 
      width: 100%; 
    }
    
    .tabs { display: flex; gap: 10px; margin-bottom: 30px; background: white; padding: 10px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); flex-wrap: wrap; }
    .tab { padding: 12px 24px; background: transparent; border: none; border-radius: 8px; cursor: pointer; font-size: 15px; color: #666; transition: all 0.3s; font-weight: 500; }
    .tab:hover { background: #f0f0f0; }
    .tab.active { background: linear-gradient(135deg, #0044cc, #0066ff); color: white; box-shadow: 0 4px 12px rgba(0,68,204,0.3); }
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.3s; }
    
    .stats-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
      gap: 25px; 
      margin-bottom: 30px; 
    }
    
    .stat-card {
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      padding: 28px;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.08);
      border: 1px solid rgba(0,68,204,0.1);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, #0044cc, #0066ff, #00aaff);
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 32px rgba(0,68,204,0.15);
    }
    
    .stat-card h3 {
      font-size: 14px;
      color: #666;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }
    
    .stat-card .value {
      font-size: 42px;
      font-weight: 700;
      background: linear-gradient(135deg, #0044cc, #0066ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
      line-height: 1;
    }
    
    .stat-card .label {
      font-size: 13px;
      color: #888;
      font-weight: 500;
    }
    
    .stat-card.present-card .value {
      background: linear-gradient(135deg, #10b981, #059669);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .stat-card.absent-card .value {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .stat-card.total-card .value {
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .stat-card.percentage-card .value {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .course-card { 
      background: white; 
      padding: 25px; 
      border-radius: 16px; 
      margin-bottom: 25px; 
      box-shadow: 0 8px 24px rgba(0,0,0,0.08); 
      border-left: 5px solid #0044cc; 
      transition: all 0.3s;
    }
    .course-card:hover { 
      transform: translateX(5px); 
      box-shadow: 0 12px 32px rgba(0,68,204,0.15); 
    }
    
    .course-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 20px; 
      flex-wrap: wrap; 
      gap: 15px; 
    }
    
    .course-name { 
      font-size: 20px; 
      font-weight: 700; 
      color: #0044cc; 
    }
    
    .section { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 8px 24px rgba(0,0,0,0.08); margin-bottom: 25px; }
    .section h2 { color: #0044cc; margin-bottom: 20px; font-size: 24px; padding-bottom: 12px; border-bottom: 3px solid #e0e0e0; }
    
    .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
    .form-row label { display: block; margin-bottom: 8px; color: #444; font-weight: 600; font-size: 14px; }
    .form-row input, .form-row select, .form-row textarea { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 14px; transition: all 0.3s; }
    .form-row input:focus, .form-row select:focus, .form-row textarea:focus { outline: none; border-color: #0044cc; box-shadow: 0 0 0 3px rgba(0,68,204,0.1); }
    
    .btn { padding: 12px 28px; border: none; border-radius: 10px; cursor: pointer; font-size: 15px; font-weight: 600; transition: all 0.3s; }
    .btn-success { background: linear-gradient(135deg, #10b981, #059669); color: white; }
    .btn-success:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(16,185,129,0.4); }
    .btn-info { background: linear-gradient(135deg, #0ea5e9, #0284c7); color: white; }
    .btn-info:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(14,165,233,0.4); }
    .btn-export { background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; margin-top: 15px; }
    .btn-export:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(139,92,246,0.4); }
    
    .students-table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .students-table thead { background: linear-gradient(135deg, #0044cc, #0066ff); color: white; }
    .students-table th { padding: 16px; text-align: left; font-weight: 600; font-size: 14px; }
    .students-table td { padding: 14px 16px; border-bottom: 1px solid #f0f0f0; }
    .students-table tbody tr:hover { background: #f8f9fa; }
    .students-table tbody tr:last-child td { border-bottom: none; }
    
    .alert { padding: 16px 20px; border-radius: 10px; margin-bottom: 20px; font-size: 14px; font-weight: 500; }
    .alert-success { background: #d1fae5; color: #065f46; border-left: 4px solid #10b981; }
    .alert-error { background: #fee2e2; color: #991b1b; border-left: 4px solid #ef4444; }
    .alert-info { background: #dbeafe; color: #1e40af; border-left: 4px solid #3b82f6; }
    .alert-warning { background: #fef3c7; color: #92400e; border-left: 4px solid #f59e0b; }
    
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      min-width: 300px;
      max-width: 500px;
      padding: 16px 20px;
      border-radius: 10px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      animation: slideIn 0.3s;
      font-weight: 500;
    }
    
    .toast.toast-success { background: #d1fae5; color: #065f46; border-left: 4px solid #10b981; }
    .toast.toast-error { background: #fee2e2; color: #991b1b; border-left: 4px solid #ef4444; }
    .toast.toast-warning { background: #fef3c7; color: #92400e; border-left: 4px solid #f59e0b; }
    
    .footer {
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      color: white;
      padding: 25px 20px;
      text-align: center;
      margin-top: auto;
      box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
      position: sticky;
      bottom: 0;
      width: 100%;
      z-index: 100;
    }
    
    .footer-content {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .footer p {
      margin: 6px 0;
      font-size: 14px;
      opacity: 0.95;
    }
    
    .footer .developer {
      font-weight: 600;
      color: #60a5fa;
      font-size: 15px;
    }
    
    .loading { 
      text-align: center; 
      padding: 40px; 
      color: #0044cc; 
      font-size: 18px; 
      font-weight: 600; 
    }
    
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }
    
    .modal-overlay.active {
      display: flex;
    }
    
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 400px;
      width: 90%;
      text-align: center;
    }
    
    .modal-content h3 {
      color: #f59e0b;
      font-size: 24px;
      margin-bottom: 15px;
    }
    
    .modal-content p {
      color: #666;
      font-size: 16px;
      margin-bottom: 25px;
    }
    
    .modal-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
    }
    
    .modal-buttons button {
      padding: 12px 30px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-cancel {
      background: #e5e7eb;
      color: #374151;
    }
    
    .btn-cancel:hover {
      background: #d1d5db;
    }
    
    .btn-confirm {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
    }
    
    .btn-confirm:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(239,68,68,0.4);
    }
    
    @keyframes fadeIn { 
      from { opacity: 0; transform: translateY(10px); } 
      to { opacity: 1; transform: translateY(0); } 
    }
    
    @keyframes slideIn { 
      from { transform: translateX(400px); opacity: 0; } 
      to { transform: translateX(0); opacity: 1; } 
    }
    
    @keyframes slideOut { 
      from { transform: translateX(0); opacity: 1; } 
      to { transform: translateX(400px); opacity: 0; } 
    }
    
    @media (max-width: 768px) {
      .stats-grid { grid-template-columns: 1fr; }
      .course-header { flex-direction: column; align-items: flex-start; }
      .header-content { flex-direction: column; gap: 15px; }
      .tabs { flex-direction: column; }
      .tab { width: 100%; }
      .login-header { flex-direction: column; }
      .login-footer .contact { flex-direction: column; gap: 8px; }
    }
    
    .lesson-plan-card { 
      background: white; 
      padding: 20px; 
      border-radius: 12px; 
      margin-bottom: 15px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
      border-left: 4px solid #0ea5e9; 
    }
    
    .lesson-plan-card.verified { 
      border-left-color: #10b981; 
      background: linear-gradient(135deg, #ffffff 0%, #f0fdf4 100%); 
    }
    
    .lesson-plan-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 12px; 
      flex-wrap: wrap; 
      gap: 10px; 
    }
    
    .verification-badge { 
      padding: 6px 14px; 
      border-radius: 20px; 
      font-size: 13px; 
      font-weight: 600; 
    }
    
    .badge-verified { 
      background: #d1fae5; 
      color: #065f46; 
    }
    
    .badge-pending { 
      background: #fef3c7; 
      color: #92400e; 
    }
    
    .lesson-details { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
      gap: 10px; 
      margin-top: 12px; 
      font-size: 14px; 
    }
    
    .btn-verify { 
      background: linear-gradient(135deg, #10b981, #059669); 
      color: white; 
      padding: 10px 20px; 
      border: none; 
      border-radius: 8px; 
      cursor: pointer; 
      font-size: 14px; 
      font-weight: 600; 
      transition: all 0.3s; 
    }
    
    .btn-verify:hover { 
      transform: translateY(-2px); 
      box-shadow: 0 5px 15px rgba(16,185,129,0.4); 
    }
    
    .warning-card { 
      background: linear-gradient(135deg, #ffffff 0%, #fef3c7 100%); 
      padding: 20px; 
      border-radius: 12px; 
      margin-bottom: 15px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
      border-left: 4px solid #f59e0b; 
    }
    
    .warning-info { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
      gap: 10px; 
      margin-top: 10px; 
      font-size: 14px; 
    }
    
    .btn-generate-letter { 
      background: linear-gradient(135deg, #ef4444, #dc2626); 
      color: white; 
      padding: 10px 20px; 
      border: none; 
      border-radius: 8px; 
      cursor: pointer; 
      font-size: 14px; 
      font-weight: 600; 
      margin-top: 12px; 
      transition: all 0.3s; 
    }
    
    .btn-generate-letter:hover { 
      transform: translateY(-2px); 
      box-shadow: 0 5px 15px rgba(239,68,68,0.4); 
    }
    
    .status-select, .notes-input { 
      padding: 8px 12px; 
      border: 2px solid #e0e0e0; 
      border-radius: 8px; 
      font-size: 14px; 
      transition: all 0.3s; 
    }
    
    .status-select:focus, .notes-input:focus { 
      outline: none; 
      border-color: #0044cc; 
      box-shadow: 0 0 0 3px rgba(0,68,204,0.1); 
    }
  </style>
</head>
<body>

<div class="login-container" id="loginContainer">
  <div class="login-box">
    <div class="login-header">
      <img src="dvetlogo.png" class="login-logo" alt="DVET Logo" onerror="this.style.display='none'">
      <img src="MSBSVET_LOGO.png" class="login-logo" alt="MSBSVET Logo" onerror="this.style.display='none'">
    </div>
    <h1>Govt ITI Nagpur</h1>
    <p class="subtitle">MSBSVET Short Term Courses Portal</p>
    <div class="form-group">
      <label>Username</label>
      <input type="text" id="username" placeholder="Enter username" autocomplete="username">
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="password" placeholder="Enter password" autocomplete="current-password">
      <span class="password-toggle" onclick="togglePassword()">üëÅÔ∏è</span>
    </div>
    <button class="btn-primary" id="loginBtn" onclick="login()">Login</button>
    
    <div class="icon-instruction">
      <strong>üèõÔ∏è Sant Jagnade Maharaj Govt. Industrial Training Institute</strong><br>
      <span style="font-size: 14px;">Shraddhanandpeth, Nagpur-440022</span><br>
      <span style="font-size: 13px;">üìß Email: iti.nagpur@dvet.gov.in</span>
    </div>
    
    <div class="login-footer">
      <p class="developer">Developed by Anand Kathalewar</p>
      <p style="font-size: 13px; color: #888;">For Government ITI Nagpur</p>
      <div class="contact">
        <a href="mailto:anand0473@zohomail.in">üìß anand0473@zohomail.in</a><br>
        <a href="https://wa.me/918208533879?text=I%20need%20help%20with%20ITI%20Short%20Term%20Course%20Portal" target="_blank" style="color: #25D366; font-weight: 600;">
          üí¨ WhatsApp Support
        </a>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="logoutModal">
  <div class="modal-content">
    <h3>‚ö†Ô∏è Confirm Logout</h3>
    <p>Are you sure you want to logout?</p>
    <div class="modal-buttons">
      <button class="btn-cancel" onclick="cancelLogout()">Cancel</button>
      <button class="btn-confirm" onclick="confirmLogout()">Logout</button>
    </div>
  </div>
</div>

<div class="app" id="app">
  <div class="header">
    <div class="header-content">
      <div class="logo-section">
        <img src="dvetlogo.png" class="logo-small" alt="DVET" onerror="this.style.display='none'">
        <div class="brand-text">
          <h1>Govt. ITI Nagpur</h1>
          <p>MSBSVET Short Term Courses Portal</p>
        </div>
        <img src="MSBSVET_LOGO.png" class="logo-small" alt="MSBSVET" onerror="this.style.display='none'">
      </div>
      <div class="user-info">
        <span class="user-name" id="userName"></span>
        <button class="btn-logout" onclick="showLogoutConfirm()">Logout</button>
      </div>
    </div>
  </div>

  <div class="main-content">
    <div class="tabs" id="tabsContainer"></div>

    <div id="dashboardTab" class="tab-content">
      <div id="dashboardContent"></div>
    </div>

    <div id="attendanceTab" class="tab-content">
      <div class="section">
        <h2>üìä Student Attendance</h2>
        <div class="form-row">
          <div>
            <label>Select Course</label>
            <select id="studentAttendanceCourse">
              <option value="">Select Course</option>
            </select>
          </div>
          <div>
            <label>Date</label>
            <input type="date" id="studentAttendanceDate">
          </div>
        </div>
        <button class="btn btn-info" onclick="loadStudentsForAttendance()">Load Students</button>
        <div id="loadingStudents" class="loading" style="display:none;">Loading students...</div>
        <table class="students-table" id="studentsTable" style="display:none;">
          <thead>
            <tr>
              <th>Student ID</th>
              <th>Name</th>
              <th>Status</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody id="studentsTableBody"></tbody>
        </table>
        <button class="btn btn-success" id="btnSaveAttendance" style="display:none; margin-top:20px;" onclick="saveStudentAttendance()">üíæ Save Attendance</button>
      </div>

      <div class="section" id="trainerAttendanceSection" style="display:none;">
        <h2>üë®‚Äçüè´ My Attendance</h2>
        
        <div id="checkInSection">
          <h3>üü¢ Check In (Start of Day)</h3>
          <div class="form-row">
            <div>
              <label>In Time</label>
              <input type="time" id="trainerInTime">
            </div>
          </div>
          <button class="btn btn-success" onclick="markTrainerCheckIn()">‚úÖ Check In</button>
          <p style="margin-top:10px; color:#666; font-size:14px;">
            üìù Mark your IN time when you start the class, then proceed to mark student attendance.
          </p>
        </div>

        <div id="checkOutSection" style="display:none; margin-top:30px; padding-top:30px; border-top:2px solid #e0e0e0;">
          <h3>üî¥ Check Out (End of Day)</h3>
          <div style="background:#f0f9ff; padding:15px; border-radius:8px; margin-bottom:15px;">
            <p style="margin:0; font-weight:bold; color:#0066cc;">
              ‚úÖ Checked In: <span id="checkedInTime"></span>
            </p>
          </div>
          <div class="form-row">
            <div>
              <label>Out Time</label>
              <input type="time" id="trainerOutTime">
            </div>
          </div>
          <button class="btn btn-danger" onclick="markTrainerCheckOut()">üî¥ Check Out</button>
          <p style="margin-top:10px; color:#666; font-size:14px;">
            ‚è∞ Mark your OUT time when leaving for the day.
          </p>
        </div>
      </div>
    </div>

    <div id="lessonTab" class="tab-content">
      <div class="section" id="lessonPlanEntrySection" style="display:none;">
        <h2>üìù Lesson Plan Entry</h2>
        <div class="form-row">
          <div>
            <label>Course</label>
            <select id="lessonCourse">
              <option value="">Select Course</option>
            </select>
          </div>
          <div>
            <label>Date</label>
            <input type="date" id="lessonPlanDate">
          </div>
        </div>
        <div class="form-row">
          <div>
            <label>Type</label>
            <select id="lessonType">
              <option value="Theory">Theory</option>
              <option value="Practical">Practical</option>
            </select>
          </div>
          <div>
            <label>Topic</label>
            <input type="text" id="lessonTopic" placeholder="Enter topic">
          </div>
        </div>
        <div class="form-row">
          <div>
            <label>Hours</label>
            <input type="number" step="0.5" id="lessonHours" placeholder="Enter hours">
          </div>
          <div>
            <label>Remarks</label>
            <textarea id="lessonRemarks" rows="3" placeholder="Optional remarks"></textarea>
          </div>
        </div>
        <button class="btn btn-success" onclick="saveLessonPlan()">üíæ Save Lesson Plan</button>
      </div>

      <div class="section" id="lessonPlanVerificationSection" style="display:none;">
        <h2>‚úÖ Lesson Plan Verification</h2>
        <div id="loadingLessonPlans" class="loading" style="display:none;">Loading lesson plans...</div>
        <div id="lessonPlansContainer"></div>
      </div>
    </div>

    <div id="reportsTab" class="tab-content">
      <div class="section">
        <h2>üìÑ Generate Reports</h2>
        <div class="form-row">
          <div>
            <label>Report Type</label>
            <select id="reportType">
              <option value="attendance">Student Attendance</option>
              <option value="lessonplan">Lesson Plans</option>
              <option value="trainer">Trainer Attendance</option>
            </select>
          </div>
          <div>
            <label>Course (Optional)</label>
            <select id="reportCourse">
              <option value="">All Courses</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div>
            <label>Start Date (Optional)</label>
            <input type="date" id="reportStartDate">
          </div>
          <div>
            <label>End Date (Optional)</label>
            <input type="date" id="reportEndDate">
          </div>
        </div>
        <button class="btn btn-info" onclick="generatePDFReport()">üì• Generate Report</button>
        <div id="reportResults" style="display:none; margin-top:30px;">
          <h3 style="color:#0044cc; margin-bottom:20px;">Report Results</h3>
          <div id="reportContent"></div>
        </div>
      </div>
    </div>

    <div id="warningsTab" class="tab-content">
      <div class="section">
        <h2>‚ö†Ô∏è Warning Letters</h2>
        <button class="btn btn-info" onclick="loadWarnings()" style="margin-bottom:20px;">üîÑ Refresh Warnings</button>
        <div id="warningsContent"></div>
      </div>
    </div>

    <div id="passwordTab" class="tab-content">
      <div class="section">
        <h2>üîê Change Password</h2>
        <div class="form-row">
          <div>
            <label>Select User</label>
            <select id="changePasswordUser">
              <option value="">Select User</option>
            </select>
          </div>
          <div>
            <label>New Password</label>
            <input type="password" id="newPassword" placeholder="Enter new password">
          </div>
        </div>
        <button class="btn btn-success" onclick="changePassword()">üíæ Change Password</button>
      </div>
    </div>
  </div>

  <div class="footer">
    <div class="footer-content">
      <p>Government Industrial Training Institute, Nagpur</p>
      <p>MSBSVET Short Term Courses Management System</p>
      <p class="developer">Developed by Anand Kathalewar</p>
    </div>
  </div>
</div>

<script>
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyvlbT5yJ0b5a4KQPNFs_hNHgMZYUjPuet_kmXADRMG8KwTH1T6ua0iV21ffGBs_lCe/exec';

// ============================================================================
// JSONP Helper Functions - Bypass CORS completely
// ============================================================================

function jsonp(url, params = {}) {
  return new Promise((resolve, reject) => {
    const callbackName = 'jsonp_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
    
    window[callbackName] = function(data) {
      delete window[callbackName];
      document.body.removeChild(script);
      resolve(data);
    };
    
    const queryParams = new URLSearchParams(params);
    const separator = url.includes('?') ? '&' : '?';
    const fullUrl = url + separator + queryParams.toString() + '&callback=' + callbackName + '&t=' + Date.now();
    
    const script = document.createElement('script');
    script.src = fullUrl;
    script.onerror = function() {
      delete window[callbackName];
      if (document.body.contains(script)) {
        document.body.removeChild(script);
      }
      reject(new Error('Failed to load script'));
    };
    
    document.body.appendChild(script);
    
    setTimeout(() => {
      if (window[callbackName]) {
        delete window[callbackName];
        if (document.body.contains(script)) {
          document.body.removeChild(script);
        }
        reject(new Error('Request timeout'));
      }
    }, 30000);
  });
}

async function apiRequest(action, params = {}) {
  try {
    const allParams = { action, ...params };
    const data = await jsonp(SCRIPT_URL, allParams);
    return data;
  } catch (error) {
    console.error('API Request failed:', error);
    throw error;
  }
}

// ============================================================================

let currentUser = null;
let coursesData = [];
let studentsData = [];
let dashboardData = [];
let courseLabels = {};
let lessonPlansData = [];
let dvetLogoData = null;
let msbsvetLogoData = null;

// Professional government emblem logo (based on typical Indian govt style)
const GOVERNMENT_LOGO = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJnMSIgeDE9IjAlIiB5MT0iMCUiIHgyPSIwJSIgeTI9IjEwMCUiPjxzdG9wIG9mZnNldD0iMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiMxMjhBREQ7c3RvcC1vcGFjaXR5OjEiLz48c3RvcCBvZmZzZXQ9IjEwMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiMwMDU1QkI7c3RvcC1vcGFjaXR5OjEiLz48L2xpbmVhckdyYWRpZW50PjwvZGVmcz48cmVjdCB3aWR0aD0iODAiIGhlaWdodD0iODAiIGZpbGw9IiNmZmZmZmYiLz48Y2lyY2xlIGN4PSI0MCIgY3k9IjQwIiByPSIzNSIgZmlsbD0idXJsKCNnMSkiIHN0cm9rZT0iI0ZGOUMwMCIgc3Ryb2tlLXdpZHRoPSIzIi8+PHBhdGggZD0iTSAyNSAzNSBMIDQwIDIwIEwgNTUgMzUgTCA1MCAzNSBMIDUwIDUwIEwgMzAgNTAgTCAzMCAzNSBaIiBmaWxsPSJ3aGl0ZSIvPjxjaXJjbGUgY3g9IjQwIiBjeT0iNjAiIHI9IjMiIGZpbGw9IiNGRjlDMDAiLz48Y2lyY2xlIGN4PSIzMCIgY3k9IjYwIiByPSIyIiBmaWxsPSIjRkY5QzAwIi8+PGNpcmNsZSBjeD0iNTAiIGN5PSI2MCIgcj0iMiIgZmlsbD0iI0ZGOUMwMCIvPjx0ZXh0IHg9IjQwIiB5PSI3NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjgiIGZvbnQtd2VpZ2h0PSJib2xkIiBmaWxsPSIjMDA1NUJCIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5EVkVUPC90ZXh0Pjwvc3ZnPg==';

const COURSE_TOTALS = {
  'C001': 30, 'C002': 30, 'C003': 30, 'C004': 30, 'C005': 30, 'C006': 30, 'C007': 30,
  'C008': 30, 'C009': 30, 'C010': 30, 'C011': 30, 'C012': 30, 'C013': 30, 'C014': 30
};
const OVERALL_TOTAL = 420;

// ULTIMATE FIX: Explicitly define all roles with default values
const ROLE_PERMISSIONS = {
  'Trainer': {
    tabs: ['dashboard', 'attendance', 'lesson', 'reports'],
    canMarkStudentAttendance: true,
    canMarkOwnAttendance: true,
    canEnterLessonPlan: true,
    canVerifyLessonPlan: false,
    canViewOwnCourseOnly: true,
    canGenerateReports: true,
    canGenerateTrainerReport: false,
    canViewWarnings: false,
    canChangePasswords: false
  },
  'TradeCoordinator': {
    tabs: ['dashboard', 'lesson', 'reports', 'warnings'],
    canMarkStudentAttendance: false,
    canMarkOwnAttendance: false,
    canEnterLessonPlan: false,
    canVerifyLessonPlan: true,
    canViewOwnCourseOnly: true,
    canGenerateReports: true,
    canGenerateTrainerReport: true,
    canViewWarnings: true,
    canChangePasswords: false
  },
  'STC': {
    tabs: ['dashboard', 'reports', 'warnings'],
    canMarkStudentAttendance: false,
    canMarkOwnAttendance: false,
    canEnterLessonPlan: false,
    canVerifyLessonPlan: false,
    canViewOwnCourseOnly: false,
    canGenerateReports: true,
    canGenerateTrainerReport: true,
    canViewWarnings: true,
    canChangePasswords: false
  },
  'Admin': {
    tabs: ['dashboard', 'reports', 'warnings', 'password'],
    canMarkStudentAttendance: false,
    canMarkOwnAttendance: false,
    canEnterLessonPlan: false,
    canVerifyLessonPlan: false,
    canViewOwnCourseOnly: false,
    canGenerateReports: true,
    canGenerateTrainerReport: true,
    canViewWarnings: true,
    canChangePasswords: true
  },
  'InstituteAdmin': {
    tabs: ['dashboard', 'reports', 'warnings', 'password'],
    canMarkStudentAttendance: false,
    canMarkOwnAttendance: false,
    canEnterLessonPlan: false,
    canVerifyLessonPlan: false,
    canViewOwnCourseOnly: false,
    canGenerateReports: true,
    canGenerateTrainerReport: true,
    canViewWarnings: true,
    canChangePasswords: true
  },
  'ShortTermCoordinator': {
    tabs: ['dashboard', 'reports', 'warnings'],
    canMarkStudentAttendance: false,
    canMarkOwnAttendance: false,
    canEnterLessonPlan: false,
    canVerifyLessonPlan: false,
    canViewOwnCourseOnly: false,
    canGenerateReports: true,
    canGenerateTrainerReport: true,
    canViewWarnings: true,
    canChangePasswords: false
  }
};

// Load logo images as base64 for PDF embedding
function loadLogosForPDF() {
  console.log('üîÑ Attempting to load logos for PDF reports...');
  
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  
  const dvetImg = new Image();
  dvetImg.crossOrigin = 'Anonymous';
  dvetImg.onload = function() {
    canvas.width = 55;
    canvas.height = 55;
    ctx.drawImage(this, 0, 0, 55, 55);
    dvetLogoData = canvas.toDataURL('image/png');
    console.log('‚úÖ DVET logo loaded successfully for PDFs');
  };
  dvetImg.onerror = function() {
    console.log('‚ö†Ô∏è DVET logo (dvetlogo.png) not found in same folder as HTML file');
    console.log('   To add logo: Save dvetlogo.png (80x80px) in same folder and refresh page');
  };
  dvetImg.src = 'dvetlogo.png';
  
  const msbsvetImg = new Image();
  msbsvetImg.crossOrigin = 'Anonymous';
  msbsvetImg.onload = function() {
    canvas.width = 55;
    canvas.height = 55;
    ctx.drawImage(this, 0, 0, 55, 55);
    msbsvetLogoData = canvas.toDataURL('image/png');
    console.log('‚úÖ MSBSVET logo loaded successfully for PDFs');
  };
  msbsvetImg.onerror = function() {
    console.log('‚ö†Ô∏è MSBSVET logo (MSBSVET_LOGO.png) not found in same folder as HTML file');
    console.log('   To add logo: Save MSBSVET_LOGO.png (80x80px) in same folder and refresh page');
  };
  msbsvetImg.src = 'MSBSVET_LOGO.png';
}

function togglePassword() {
  const passwordInput = document.getElementById('password');
  const toggle = document.querySelector('.password-toggle');
  
  if (passwordInput.type === 'password') {
    passwordInput.type = 'text';
    toggle.textContent = 'üôà';
  } else {
    passwordInput.type = 'password';
    toggle.textContent = 'üëÅÔ∏è';
  }
}

function showLogoutConfirm() {
  document.getElementById('logoutModal').classList.add('active');
}

function cancelLogout() {
  document.getElementById('logoutModal').classList.remove('active');
}

function confirmLogout() {
  document.getElementById('logoutModal').classList.remove('active');
  showToast('Logged out successfully!', 'warning');
  setTimeout(() => {
    logout();
  }, 500);
}

async function login() {
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value.trim();
  const loginBtn = document.getElementById('loginBtn');
  
  if (!username || !password) {
    showToast('Please enter username and password', 'error');
    return;
  }
  
  loginBtn.disabled = true;
  loginBtn.innerHTML = '<span class="loading-spinner"></span>Logging in...';
  
  try {
    const data = await apiRequest('login', { username, password });
    
    if (data.success && data.user) {
      currentUser = data.user;
      
      // ULTIMATE FIX: Normalize role name and check
      const normalizedRole = currentUser.role.trim();
      console.log('User role:', normalizedRole);
      console.log('Available permissions:', Object.keys(ROLE_PERMISSIONS));
      
      if (!ROLE_PERMISSIONS[normalizedRole]) {
        console.error('Role not found:', normalizedRole);
        showToast('Invalid user role configuration. Please contact administrator.', 'error');
        loginBtn.disabled = false;
        loginBtn.innerHTML = 'Login';
        return;
      }
      
      currentUser.role = normalizedRole;
      
      // Load data
      await Promise.all([
        loadCourseLabels(),
        loadCourses()
      ]);
      
      document.getElementById('userName').textContent = currentUser.name + ' (' + currentUser.role + ')';
      document.getElementById('loginContainer').style.display = 'none';
      document.getElementById('app').style.display = 'flex';
      
      setupTabs();
      showTab('dashboard');
      showToast('Login successful! Welcome ' + currentUser.name, 'success');
    } else {
      showToast(data.message || 'Invalid username or password', 'error');
    }
  } catch (error) {
    console.error('Login error:', error);
    showToast('Unable to connect to server. Please check your internet connection and try again. Error: ' + error.message, 'error');
  } finally {
    loginBtn.disabled = false;
    loginBtn.innerHTML = 'Login';
  }
}

function logout() {
  currentUser = null;
  coursesData = [];
  studentsData = [];
  dashboardData = [];
  document.getElementById('app').style.display = 'none';
  document.getElementById('loginContainer').style.display = 'flex';
  document.getElementById('username').value = '';
  document.getElementById('password').value = '';
  document.getElementById('password').type = 'password';
  document.querySelector('.password-toggle').textContent = 'üëÅÔ∏è';
}

async function loadCourseLabels() {
  try {
    console.log('üè∑Ô∏è Loading course labels...');
    const data = await apiRequest('getCourseLabels');
    console.log('üì¶ Course labels response:', data);
    if (data.success) {
      courseLabels = data.labels;
      console.log('‚úÖ Course labels loaded:', courseLabels);
    } else {
      console.error('‚ùå Failed to load course labels:', data);
    }
  } catch (error) {
    console.error('‚ùå Failed to load course labels:', error);
  }
}

async function loadCourses() {
  try {
    console.log('üìö Loading courses...');
    const data = await apiRequest('getCourses', { 
      userId: currentUser.userId, 
      role: currentUser.role,
      courseId: currentUser.courseId  // FIXED: Send user's courseId
    });
    console.log('üì¶ Courses response:', data);
    
    if (data.success) {
      coursesData = data.courses;
      console.log('‚úÖ Courses loaded:', coursesData);
      populateCourseDropdowns();
    } else {
      console.error('‚ùå Failed to load courses:', data);
    }
  } catch (error) {
    console.error('‚ùå Failed to load courses:', error);
    showToast('Failed to load courses', 'error');
  }
}

function populateCourseDropdowns() {
  const courseSelects = ['studentAttendanceCourse', 'lessonCourse', 'reportCourse'];
  
  console.log('üé® Populating course dropdowns with courseLabels:', courseLabels);
  
  courseSelects.forEach(selectId => {
    const select = document.getElementById(selectId);
    if (select) {
      const currentValue = select.value;
      select.innerHTML = '<option value="">Select Course</option>';
      
      // If coursesData has courses, use it (filtered by role)
      if (coursesData && coursesData.length > 0) {
        coursesData.forEach(course => {
          const option = document.createElement('option');
          option.value = course.courseId;
          option.textContent = courseLabels[course.courseId] || course.courseId;
          select.appendChild(option);
        });
      } else {
        // Otherwise, use ALL courses from courseLabels
        console.log('‚ö†Ô∏è coursesData empty, using ALL courseLabels');
        Object.keys(courseLabels).forEach(courseId => {
          const option = document.createElement('option');
          option.value = courseId;
          option.textContent = courseLabels[courseId];
          select.appendChild(option);
        });
      }
      
      if (currentValue) select.value = currentValue;
    }
  });
  
  console.log('‚úÖ Course dropdowns populated');
}

function setupTabs() {
  const permissions = ROLE_PERMISSIONS[currentUser.role];
  
  if (!permissions || !permissions.tabs) {
    showToast('Error: Invalid role configuration', 'error');
    console.error('Missing permissions for role:', currentUser.role);
    return;
  }
  
  const tabsContainer = document.getElementById('tabsContainer');
  tabsContainer.innerHTML = '';
  
  const tabConfig = {
    dashboard: 'üìä Dashboard',
    attendance: '‚úÖ Attendance',
    lesson: 'üìù Lesson Plans',
    reports: 'üìÑ Reports',
    warnings: '‚ö†Ô∏è Warnings',
    password: 'üîê Password'
  };
  
  permissions.tabs.forEach(tabId => {
    const button = document.createElement('button');
    button.className = 'tab';
    button.textContent = tabConfig[tabId];
    button.setAttribute('data-tab', tabId);
    button.onclick = () => showTab(tabId);
    tabsContainer.appendChild(button);
  });
  
  if (permissions.canMarkOwnAttendance) {
    document.getElementById('trainerAttendanceSection').style.display = 'block';
  }
  
  if (permissions.canEnterLessonPlan) {
    document.getElementById('lessonPlanEntrySection').style.display = 'block';
  } else {
    document.getElementById('lessonPlanEntrySection').style.display = 'none';
  }
  
  if (permissions.canVerifyLessonPlan) {
    document.getElementById('lessonPlanVerificationSection').style.display = 'block';
  }
}

function showTab(tabId) {
  document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
  
  const activeTab = document.querySelector(`[data-tab="${tabId}"]`);
  if (activeTab) activeTab.classList.add('active');
  
  const tabContent = document.getElementById(tabId + 'Tab');
  if (tabContent) tabContent.classList.add('active');
  
  if (tabId === 'dashboard') {
    loadDashboardData();
  } else if (tabId === 'attendance') {
    checkTrainerAttendanceStatus();
  } else if (tabId === 'lesson' && ROLE_PERMISSIONS[currentUser.role] && ROLE_PERMISSIONS[currentUser.role].canVerifyLessonPlan) {
    loadLessonPlansForVerification();
  } else if (tabId === 'reports') {
    populateCourseDropdowns();
  } else if (tabId === 'warnings') {
    loadWarnings();
  } else if (tabId === 'password') {
    loadUsersForPasswordChange();
  }
}

function getTodayDate() {
  const today = new Date();
  const year = today.getFullYear();
  const month = String(today.getMonth() + 1).padStart(2, '0');
  const day = String(today.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

function validateDateNotFuture(dateString, fieldName) {
  const today = getTodayDate();
  if (dateString > today) {
    showToast(`${fieldName} cannot be in the future. You can only enter details up to today's date.`, 'error');
    return false;
  }
  return true;
}

async function loadDashboardData() {
  const today = getTodayDate();
  
  try {
    console.log('üìä Loading dashboard data for date:', today);
    console.log('üìä User:', currentUser);
    const data = await apiRequest('getDashboardData', { 
      date: today, 
      userId: currentUser.userId, 
      role: currentUser.role,
      courseId: currentUser.courseId  // FIXED: Send user's courseId
    });
    console.log('üì¶ Dashboard response:', data);
    
    if (data.success) {
      dashboardData = data.data;
      console.log('‚úÖ Dashboard data loaded:', dashboardData);
      renderDashboard();
    } else {
      console.error('‚ùå Dashboard load failed:', data);
      
      // Show user-friendly error
      if (data.error && data.error.includes('Cannot read properties of null')) {
        showToast('Backend error: A worksheet may be missing. Please check Google Sheets setup.', 'error');
        document.getElementById('dashboardContent').innerHTML = `
          <div class="alert alert-error">
            <h3>‚ö†Ô∏è Backend Configuration Error</h3>
            <p>The backend cannot find a required worksheet.</p>
            <p><strong>Error:</strong> ${data.error}</p>
            <p>Please check your Google Sheets and ensure all worksheets exist.</p>
          </div>
        `;
      } else {
        showToast(data.error || 'Failed to load dashboard data', 'error');
      }
    }
  } catch (error) {
    console.error('‚ùå Dashboard load error:', error);
    showToast('Failed to load dashboard: ' + error.message, 'error');
  }
}

function renderDashboard() {
  const container = document.getElementById('dashboardContent');
  const permissions = ROLE_PERMISSIONS[currentUser.role];
  
  if (permissions.canViewOwnCourseOnly) {
    const courseData = dashboardData.find(d => d.courseId === currentUser.courseId);
    if (!courseData) {
      container.innerHTML = '<p class="alert alert-info">No data available</p>';
      return;
    }
    
    const fixedTotal = COURSE_TOTALS[courseData.courseId] || 30;
    const attendancePercentage = fixedTotal > 0 ? parseFloat(((courseData.present / fixedTotal) * 100).toFixed(1)) : 0;
    
    container.innerHTML = `
      <div class="course-card">
        <div class="course-header">
          <h3 class="course-name">${courseLabels[courseData.courseId] || courseData.courseId}</h3>
        </div>
        
        <div class="stats-grid">
          <div class="stat-card present-card">
            <h3>Present Today</h3>
            <div class="value">${courseData.present}</div>
            <div class="label">Students Present</div>
          </div>
          
          <div class="stat-card absent-card">
            <h3>Absent Today</h3>
            <div class="value">${courseData.absent}</div>
            <div class="label">Students Absent</div>
          </div>
          
          <div class="stat-card total-card">
            <h3>Total Students</h3>
            <div class="value">${fixedTotal}</div>
            <div class="label">Batch Size</div>
          </div>
          
          <div class="stat-card percentage-card">
            <h3>Attendance %</h3>
            <div class="value">${attendancePercentage}%</div>
            <div class="label">Today's Rate</div>
          </div>
        </div>
        
        <div class="stats-grid">
          <div class="stat-card">
            <h3>Theory Hours</h3>
            <div class="value" style="font-size:32px;">${courseData.theoryHours || 0} / ${courseData.theoryTarget || 0}</div>
            <div class="label">Completed / Target</div>
          </div>
          
          <div class="stat-card">
            <h3>Practical Hours</h3>
            <div class="value" style="font-size:32px;">${courseData.practicalHours || 0} / ${courseData.practicalTarget || 0}</div>
            <div class="label">Completed / Target</div>
          </div>
        </div>
      </div>
    `;
  } else {
    let totalPresent = 0;
    let totalAbsent = 0;
    
    dashboardData.forEach(course => {
      totalPresent += course.present;
      totalAbsent += course.absent;
    });
    
    const overallPercentage = OVERALL_TOTAL > 0 ? parseFloat(((totalPresent / OVERALL_TOTAL) * 100).toFixed(1)) : 0;
    
    let html = `
      <div class="section">
        <h2>üìä Overall Summary</h2>
        <div class="stats-grid">
          <div class="stat-card present-card">
            <h3>Total Present</h3>
            <div class="value">${totalPresent}</div>
            <div class="label">Students Present Today</div>
          </div>
          
          <div class="stat-card absent-card">
            <h3>Total Absent</h3>
            <div class="value">${totalAbsent}</div>
            <div class="label">Students Absent Today</div>
          </div>
          
          <div class="stat-card total-card">
            <h3>Total Students</h3>
            <div class="value">${OVERALL_TOTAL}</div>
            <div class="label">All Courses Combined</div>
          </div>
          
          <div class="stat-card percentage-card">
            <h3>Attendance %</h3>
            <div class="value">${overallPercentage}%</div>
            <div class="label">Overall Rate</div>
          </div>
        </div>
      </div>
      
      <div class="section">
        <h2>üìö Course-wise Details</h2>
    `;
    
    dashboardData.forEach(course => {
      const fixedTotal = COURSE_TOTALS[course.courseId] || 30;
      const coursePercentage = fixedTotal > 0 ? parseFloat(((course.present / fixedTotal) * 100).toFixed(1)) : 0;
      
      html += `
        <div class="course-card">
          <div class="course-header">
            <h3 class="course-name">${courseLabels[course.courseId] || course.courseId}</h3>
          </div>
          
          <div class="stats-grid">
            <div class="stat-card present-card">
              <h3>Present</h3>
              <div class="value">${course.present}</div>
            </div>
            
            <div class="stat-card absent-card">
              <h3>Absent</h3>
              <div class="value">${course.absent}</div>
            </div>
            
            <div class="stat-card total-card">
              <h3>Total</h3>
              <div class="value">${fixedTotal}</div>
            </div>
            
            <div class="stat-card percentage-card">
              <h3>Attendance %</h3>
              <div class="value">${coursePercentage}%</div>
            </div>
          </div>
          
          <div class="stats-grid">
            <div class="stat-card">
              <h3>Theory</h3>
              <div class="value" style="font-size:28px;">${course.theoryHours || 0}/${course.theoryTarget || 0}</div>
              <div class="label">Hours</div>
            </div>
            
            <div class="stat-card">
              <h3>Practical</h3>
              <div class="value" style="font-size:28px;">${course.practicalHours || 0}/${course.practicalTarget || 0}</div>
              <div class="label">Hours</div>
            </div>
          </div>
        </div>
      `;
    });
    
    html += '</div>';
    container.innerHTML = html;
  }
}

// Trainer Check In (Start of Day)
async function markTrainerCheckIn() {
  const inTime = document.getElementById('trainerInTime').value;
  
  if (!inTime) {
    showToast('Please enter IN time', 'error');
    return;
  }
  
  const today = getTodayDate();
  if (!validateDateNotFuture(today, 'Attendance date')) return;
  
  try {
    sessionStorage.setItem('trainerCheckInTime', inTime);
    sessionStorage.setItem('trainerCheckInDate', today);
    
    showToast('‚úÖ Checked in successfully at ' + inTime, 'success');
    
    document.getElementById('checkInSection').style.display = 'none';
    document.getElementById('checkOutSection').style.display = 'block';
    document.getElementById('checkedInTime').textContent = inTime;
    document.getElementById('trainerInTime').value = '';
    
  } catch (error) {
    console.error('Check-in error:', error);
    showToast('Failed to check in', 'error');
  }
}

// Trainer Check Out (End of Day)
async function markTrainerCheckOut() {
  const outTime = document.getElementById('trainerOutTime').value;
  const inTime = sessionStorage.getItem('trainerCheckInTime');
  const checkInDate = sessionStorage.getItem('trainerCheckInDate');
  
  if (!outTime) {
    showToast('Please enter OUT time', 'error');
    return;
  }
  
  if (!inTime) {
    showToast('Please check in first!', 'error');
    return;
  }
  
  const today = getTodayDate();
  
  const inParts = inTime.split(':');
  const outParts = outTime.split(':');
  const inMinutes = parseInt(inParts[0]) * 60 + parseInt(inParts[1]);
  const outMinutes = parseInt(outParts[0]) * 60 + parseInt(outParts[1]);
  const totalMinutes = outMinutes - inMinutes;
  
  if (totalMinutes <= 0) {
    showToast('OUT time must be after IN time', 'error');
    return;
  }
  
  const totalHours = (totalMinutes / 60).toFixed(2);
  
  try {
    const data = await apiRequest('saveTrainerAttendance', {
      date: checkInDate || today,
      userId: currentUser.userId,
      userName: currentUser.name,
      courseId: currentUser.courseId,
      inTime: inTime,
      outTime: outTime,
      totalHours: totalHours
    });
    
    if (data.success) {
      showToast('‚úÖ Checked out successfully! Total hours: ' + totalHours, 'success');
      
      sessionStorage.removeItem('trainerCheckInTime');
      sessionStorage.removeItem('trainerCheckInDate');
      
      document.getElementById('checkInSection').style.display = 'block';
      document.getElementById('checkOutSection').style.display = 'none';
      document.getElementById('trainerOutTime').value = '';
      
    } else {
      showToast(data.message || 'Failed to check out', 'error');
    }
  } catch (error) {
    console.error('Check-out error:', error);
    showToast('Failed to check out', 'error');
  }
}

// Check trainer attendance status
function checkTrainerAttendanceStatus() {
  const inTime = sessionStorage.getItem('trainerCheckInTime');
  const checkInDate = sessionStorage.getItem('trainerCheckInDate');
  const today = getTodayDate();
  
  if (inTime && checkInDate === today) {
    document.getElementById('checkInSection').style.display = 'none';
    document.getElementById('checkOutSection').style.display = 'block';
    document.getElementById('checkedInTime').textContent = inTime;
  } else {
    sessionStorage.removeItem('trainerCheckInTime');
    sessionStorage.removeItem('trainerCheckInDate');
    document.getElementById('checkInSection').style.display = 'block';
    document.getElementById('checkOutSection').style.display = 'none';
  }
}

async function loadStudentsForAttendance() {
  const courseId = document.getElementById('studentAttendanceCourse').value;
  const dateStr = document.getElementById('studentAttendanceDate').value;
  
  if (!courseId) {
    showToast('Please select a course', 'error');
    return;
  }
  
  if (!dateStr) {
    showToast('Please select a date', 'error');
    return;
  }
  
  if (!validateDateNotFuture(dateStr, 'Attendance date')) return;
  
  document.getElementById('loadingStudents').style.display = 'block';
  
  try {
    const studData = await apiRequest('getStudents', { courseId });
    
    if (studData.success) {
      studentsData = studData.students;
      
      const attData = await apiRequest('getAttendance', { date: dateStr, courseId });
      
      if (attData.success && attData.attendance.length > 0) {
        showToast('Attendance already marked for this date', 'info');
        document.getElementById('loadingStudents').style.display = 'none';
        return;
      }
      
      renderStudentsTable();
    }
  } catch (error) {
    console.error('Load students error:', error);
    showToast('Failed to load students', 'error');
  } finally {
    document.getElementById('loadingStudents').style.display = 'none';
  }
}

function renderStudentsTable() {
  const tbody = document.getElementById('studentsTableBody');
  tbody.innerHTML = '';
  
  studentsData.forEach(student => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${student.studentId}</td>
      <td>${student.name}</td>
      <td>
        <select class="status-select" data-student-id="${student.studentId}">
          <option value="present">Present</option>
          <option value="absent">Absent</option>
        </select>
      </td>
      <td>
        <input type="text" class="notes-input" data-student-id="${student.studentId}">
      </td>
    `;
    tbody.appendChild(row);
  });
  
  document.getElementById('studentsTable').style.display = 'table';
  document.getElementById('btnSaveAttendance').style.display = 'block';
}

async function saveStudentAttendance() {
  const courseId = document.getElementById('studentAttendanceCourse').value;
  const dateStr = document.getElementById('studentAttendanceDate').value;
  
  if (!validateDateNotFuture(dateStr, 'Attendance date')) return;
  
  const attendanceRecords = [];
  
  document.querySelectorAll('.status-select').forEach(select => {
    const studentId = select.getAttribute('data-student-id');
    const status = select.value === 'present' ? 'Y' : 'N';
    const notesInput = document.querySelector(`.notes-input[data-student-id="${studentId}"]`);
    
    attendanceRecords.push({
      studentId: studentId,
      status: status,
      notes: notesInput ? notesInput.value : ''
    });
  });
  
  try {
    // FIXED: Use JSONP (GET) instead of POST to avoid CORS
    const data = await apiRequest('saveStudentAttendance', {
      date: dateStr,
      courseId: courseId,
      attendanceData: JSON.stringify(attendanceRecords),
      markedBy: currentUser.userId
    });
    
    if (data.success) {
      showToast('Attendance saved successfully for ' + dateStr + '!', 'success');
      document.getElementById('studentsTable').style.display = 'none';
      document.getElementById('btnSaveAttendance').style.display = 'none';
      loadDashboardData();
    } else {
      showToast(data.message || 'Failed to save attendance', 'error');
    }
  } catch (error) {
    console.error('Save attendance error:', error);
    showToast('Failed to save attendance', 'error');
  }
}

async function saveLessonPlan() {
  const permissions = ROLE_PERMISSIONS[currentUser.role];
  if (!permissions.canEnterLessonPlan) {
    showToast('Access denied', 'error');
    return;
  }
  
  const courseId = document.getElementById('lessonCourse').value;
  const dateStr = document.getElementById('lessonPlanDate').value;
  const type = document.getElementById('lessonType').value;
  const topic = document.getElementById('lessonTopic').value;
  const hours = document.getElementById('lessonHours').value;
  const remarks = document.getElementById('lessonRemarks').value;
  
  if (!courseId || !dateStr || !topic || !hours) {
    showToast('Please fill all required fields', 'error');
    return;
  }
  
  if (!validateDateNotFuture(dateStr, 'Lesson plan date')) return;
  
  try {
    // FIXED: Use JSONP (GET) instead of POST to avoid CORS
    const data = await apiRequest('saveLessonPlan', {
      date: dateStr,
      courseId: courseId,
      trainerId: currentUser.userId,
      type: type,
      topic: topic,
      hours: hours,
      remarks: remarks
    });
    
    if (data.success) {
      showToast('Lesson plan saved successfully for ' + dateStr + '!', 'success');
      document.getElementById('lessonPlanDate').value = '';
      document.getElementById('lessonTopic').value = '';
      document.getElementById('lessonHours').value = '';
      document.getElementById('lessonRemarks').value = '';
      loadDashboardData();
    } else {
      showToast(data.message || 'Failed to save lesson plan', 'error');
    }
  } catch (error) {
    console.error('Save lesson plan error:', error);
    showToast('Failed to save lesson plan', 'error');
  }
}

async function loadLessonPlansForVerification() {
  document.getElementById('loadingLessonPlans').style.display = 'block';
  
  try {
    const data = await apiRequest('getLessonPlans', { 
      courseId: currentUser.courseId, 
      startDate: '', 
      endDate: '',
      role: currentUser.role,  // FIXED: Send role for filtering
      userCourseId: currentUser.courseId  // FIXED: Send for backend filtering
    });
    
    if (data.success) {
      lessonPlansData = data.lessonPlans;
      renderLessonPlansForVerification();
    }
  } catch (error) {
    console.error('Load lesson plans error:', error);
    showToast('Failed to load lesson plans', 'error');
  } finally {
    document.getElementById('loadingLessonPlans').style.display = 'none';
  }
}

function renderLessonPlansForVerification() {
  const container = document.getElementById('lessonPlansContainer');
  container.innerHTML = '';
  
  if (lessonPlansData.length === 0) {
    container.innerHTML = '<p class="alert alert-info">No lesson plans found.</p>';
    return;
  }
  
  lessonPlansData.forEach(plan => {
    const isVerified = plan.verifiedBy && plan.verifiedBy.length > 0;
    const courseName = courseLabels[plan.courseId] || plan.courseId;
    
    const card = document.createElement('div');
    card.className = 'lesson-plan-card' + (isVerified ? ' verified' : '');
    card.innerHTML = `
      <div class="lesson-plan-header">
        <h4>${plan.topic}</h4>
        <span class="verification-badge ${isVerified ? 'badge-verified' : 'badge-pending'}">
          ${isVerified ? '‚úÖ Verified' : '‚è≥ Pending'}
        </span>
      </div>
      <div class="lesson-details">
        <div><strong>Date:</strong> ${plan.date}</div>
        <div><strong>Course:</strong> ${courseName}</div>
        <div><strong>Type:</strong> ${plan.type}</div>
        <div><strong>Hours:</strong> ${plan.hours}</div>
        <div><strong>Remarks:</strong> ${plan.remarks || 'None'}</div>
      </div>
      ${!isVerified ? `<button class="btn-verify" style="margin-top:15px;" onclick="verifyLessonPlan('${plan.date}','${plan.topic}')">‚úÖ Verify</button>` : ''}
    `;
    container.appendChild(card);
  });
}

async function verifyLessonPlan(date, topic) {
  try {
    const data = await apiRequest('verifyLessonPlan', {
      date: date,
      courseId: currentUser.courseId,
      topic: topic,
      verifiedBy: currentUser.userId
    });
    
    if (data.success) {
      showToast('Lesson plan verified successfully!', 'success');
      loadLessonPlansForVerification();
    } else {
      showToast(data.message || 'Failed to verify', 'error');
    }
  } catch (error) {
    console.error('Verify lesson plan error:', error);
    showToast('Failed to verify lesson plan: ' + error.message, 'error');
  }
}

async function generatePDFReport() {
  const permissions = ROLE_PERMISSIONS[currentUser.role];
  if (!permissions.canGenerateReports) {
    showToast('Access denied', 'error');
    return;
  }
  
  const type = document.getElementById('reportType').value;
  
  if (type === 'trainer' && !permissions.canGenerateTrainerReport) {
    showToast('Trainers cannot generate trainer reports', 'error');
    return;
  }
  
  let courseId = document.getElementById('reportCourse').value;
  const startDate = document.getElementById('reportStartDate').value;
  const endDate = document.getElementById('reportEndDate').value;
  
  if (permissions.canViewOwnCourseOnly && !courseId) {
    courseId = currentUser.courseId;
  }
  
  try {
    const data = await apiRequest('generateReport', { 
      type, 
      courseId, 
      startDate, 
      endDate, 
      role: currentUser.role,
      userCourseId: currentUser.courseId  // FIXED: Send user's courseId for filtering
    });
    
    if (data.success && data.report) {
      displayReportAndGeneratePDF(data.report.records, type, courseId);
    } else {
      showToast(data.message || data.error || 'No data found for selected criteria', 'error');
      console.error('Report generation failed:', data);
    }
  } catch (error) {
    console.error('Generate report error:', error);
    showToast('Failed to generate report', 'error');
  }
}

function displayReportAndGeneratePDF(report, type, courseId) {
  const resultsDiv = document.getElementById('reportResults');
  const contentDiv = document.getElementById('reportContent');
  
  if (report.length === 0) {
    contentDiv.innerHTML = '<p class="alert alert-info">No data found for the selected criteria.</p>';
    resultsDiv.style.display = 'block';
    return;
  }
  
  let courseName = 'All Courses';
  if (courseId) {
    courseName = courseLabels[courseId] || courseId;
  }
  
  let tableHTML = '<table class="students-table"><thead><tr>';
  let columns = [];
  
  if (type === 'attendance') {
    columns = ['Date', 'Student ID', 'Name', 'Status', 'Notes', 'Marked By'];
    tableHTML += columns.map(col => `<th>${col}</th>`).join('');
    tableHTML += '</tr></thead><tbody>';
    report.forEach(record => {
      tableHTML += `
        <tr>
          <td>${record.date}</td>
          <td>${record.studentId}</td>
          <td>${record.studentName}</td>
          <td>${record.status}</td>
          <td>${record.notes}</td>
          <td>${record.markedBy}</td>
        </tr>
      `;
    });
  } else if (type === 'lessonplan') {
    columns = ['Date', 'Course', 'Topic', 'Type', 'Hours', 'Verified By', 'Remarks'];
    tableHTML += columns.map(col => `<th>${col}</th>`).join('');
    tableHTML += '</tr></thead><tbody>';
    report.forEach(record => {
      const courseName = courseLabels[record.courseId] || record.courseId;
      tableHTML += `
        <tr>
          <td>${record.date}</td>
          <td>${courseName}</td>
          <td>${record.topic}</td>
          <td>${record.type}</td>
          <td>${record.hours}</td>
          <td>${record.verified}</td>
          <td>${record.remarks}</td>
        </tr>
      `;
    });
  } else if (type === 'trainer') {
    columns = ['Date', 'Name', 'Course', 'In Time', 'Out Time', 'Total Hours'];
    tableHTML += columns.map(col => `<th>${col}</th>`).join('');
    tableHTML += '</tr></thead><tbody>';
    report.forEach(record => {
      const courseName = courseLabels[record.courseId] || record.courseId;
      tableHTML += `
        <tr>
          <td>${record.date}</td>
          <td>${record.name}</td>
          <td>${courseName}</td>
          <td>${record.inTime}</td>
          <td>${record.outTime}</td>
          <td>${record.totalHours}</td>
        </tr>
      `;
    });
  }
  
  tableHTML += '</tbody></table>';
  tableHTML += '<br><button class="btn-export" onclick="downloadCurrentReportAsPDF()">üì• Download PDF</button>';
  
  contentDiv.innerHTML = tableHTML;
  resultsDiv.style.display = 'block';
  
  window.currentReportData = {
    report: report,
    type: type,
    courseName: courseName,
    columns: columns
  };
}

function downloadCurrentReportAsPDF() {
  if (!window.currentReportData) return;
  
  const { report, type, courseName, columns } = window.currentReportData;
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  // Add logos if available (or use government logo)
  const logoToUse = dvetLogoData || GOVERNMENT_LOGO;
  
  try {
    doc.addImage(logoToUse, 'PNG', 10, 8, 20, 20);
    if (dvetLogoData) {
      console.log('‚úÖ Custom DVET logo added to PDF');
    } else {
      console.log('‚úÖ Government emblem logo added to PDF');
    }
  } catch(e) {
    console.error('‚ùå Could not add logo to PDF:', e);
  }
  
  if (msbsvetLogoData) {
    try {
      doc.addImage(msbsvetLogoData, 'PNG', 180, 8, 20, 20);
      console.log('‚úÖ MSBSVET logo added to PDF');
    } catch(e) {
      console.error('‚ùå Could not add MSBSVET logo to PDF:', e);
    }
  }
  
  doc.setFontSize(18);
  doc.text('Govt ITI Nagpur', 105, 15, { align: 'center' });
  doc.setFontSize(14);
  doc.text('MSBSVET Short Term Courses', 105, 22, { align: 'center' });
  doc.setFontSize(12);
  doc.text('Course: ' + courseName, 105, 29, { align: 'center' });
  
  let reportTitle = '';
  if (type === 'attendance') reportTitle = 'Attendance Report';
  else if (type === 'lessonplan') reportTitle = 'Lesson Plan Report';
  else if (type === 'trainer') reportTitle = 'Trainer Attendance Report';
  
  doc.setFontSize(14);
  doc.setFont(undefined, 'bold');
  doc.text(reportTitle, 105, 38, { align: 'center' });
  
  const tableData = report.map(record => {
    if (type === 'attendance') {
      return [record.date, record.studentId, record.studentName, record.status, record.notes, record.markedBy];
    } else if (type === 'lessonplan') {
      const courseName = courseLabels[record.courseId] || record.courseId;
      return [record.date, courseName, record.topic, record.type, record.hours, record.verified, record.remarks];
    } else if (type === 'trainer') {
      const courseName = courseLabels[record.courseId] || record.courseId;
      return [record.date, record.name, courseName, record.inTime, record.outTime, record.totalHours];
    }
  });
  
  doc.autoTable({
    head: [columns],
    body: tableData,
    startY: 45,
    styles: { fontSize: 9, cellPadding: 3 },
    headStyles: { fillColor: [0, 68, 204], textColor: 255 }
  });
  
  const finalY = doc.lastAutoTable.finalY || 45;
  doc.setFontSize(10);
  doc.text('Generated: ' + new Date().toLocaleString(), 14, finalY + 10);
  doc.setFont(undefined, 'italic');
  doc.text('Developed by Anand Kathalewar for Govt ITI Nagpur', 105, finalY + 16, { align: 'center' });
  
  doc.save(reportTitle + '_' + courseName + '_' + new Date().toISOString().split('T')[0] + '.pdf');
  showToast('PDF downloaded successfully!', 'success');
}

async function loadWarnings() {
  const permissions = ROLE_PERMISSIONS[currentUser.role];
  if (!permissions.canViewWarnings) {
    showToast('Access denied', 'error');
    return;
  }
  
  try {
    const data = await apiRequest('getWarningLetters', { 
      role: currentUser.role,
      userCourseId: currentUser.courseId
    });
    
    if (data.success) {
      displayWarnings(data.warnings);
      showToast(`Loaded ${data.warnings.length} warning(s)`, 'success');
    }
  } catch (error) {
    console.error('Load warnings error:', error);
    showToast('Failed to load warnings', 'error');
  }
}

function displayWarnings(warnings) {
  const container = document.getElementById('warningsContent');
  
  if (warnings.length === 0) {
    container.innerHTML = '<p class="alert alert-success">‚úÖ No warnings issued. All students have good attendance!</p>';
    return;
  }
  
  container.innerHTML = '';
  
  warnings.forEach(warning => {
    const courseName = courseLabels[warning.courseId] || warning.courseId;
    const card = document.createElement('div');
    card.className = 'warning-card';
    card.innerHTML = `
      <h4>‚ö†Ô∏è ${warning.name} (${warning.studentId})</h4>
      <div class="warning-info">
        <div><strong>Course:</strong> ${courseName}</div>
        <div><strong>Consecutive Absences:</strong> ${warning.consecutiveAbsences} days</div>
        <div><strong>Attendance:</strong> ${warning.attendancePercent}%</div>
      </div>
      <p style="margin:10px 0;"><strong>Absent Dates:</strong> ${warning.absentDates.join(', ')}</p>
      <button class="btn-generate-letter" onclick='generateWarningPDF(${JSON.stringify(warning).replace(/'/g, "&apos;")})'>üìÑ Generate Warning Letter PDF</button>
    `;
    container.appendChild(card);
  });
}

// FIXED: English-only professional warning letter
function generateWarningPDF(warning) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  // Add logos if available (or use government logo)
  const logoToUse = dvetLogoData || GOVERNMENT_LOGO;
  
  try {
    doc.addImage(logoToUse, 'PNG', 10, 8, 20, 20);
    if (dvetLogoData) {
      console.log('‚úÖ DVET logo added to warning letter PDF');
    } else {
      console.log('‚ÑπÔ∏è Using government logo in warning letter');
    }
  } catch(e) {
    console.error('‚ùå Could not add logo to warning letter:', e);
  }
  
  if (msbsvetLogoData) {
    try {
      doc.addImage(msbsvetLogoData, 'PNG', 180, 8, 20, 20);
      console.log('‚úÖ MSBSVET logo added to warning letter PDF');
    } catch(e) {
      console.error('‚ùå Could not add MSBSVET logo to warning letter:', e);
    }
  }
  
  // Header
  doc.setFontSize(16);
  doc.setFont(undefined, 'bold');
  doc.text('Government Industrial Training Institute, Nagpur', 105, 20, { align: 'center' });
  doc.setFontSize(12);
  doc.setFont(undefined, 'normal');
  doc.text('Maharashtra State Board of Skill, Vocational Education & Training', 105, 27, { align: 'center' });
  doc.text('Short Term Courses Programme', 105, 33, { align: 'center' });
  
  // Date and Office Number
  const today = new Date().toLocaleDateString('en-GB');
  doc.setFontSize(10);
  doc.text('Date: ' + today, 14, 45);
  doc.text('Ref. No.: ITINGP/STC/' + new Date().getFullYear() + '/________', 120, 45);
  
  // Warning Letter Title
  doc.setFontSize(14);
  doc.setFont(undefined, 'bold');
  doc.setFillColor(255, 240, 240);
  doc.rect(40, 52, 130, 10, 'F');
  doc.text('WARNING LETTER', 105, 59, { align: 'center' });
  
  // To Section
  doc.setFontSize(11);
  doc.setFont(undefined, 'normal');
  doc.text('To,', 14, 72);
  doc.setFont(undefined, 'bold');
  doc.text(warning.name, 14, 78);
  doc.setFont(undefined, 'normal');
  doc.text('Student ID: ' + warning.studentId, 14, 84);
  
  // Get course name
  const courseName = courseLabels[warning.courseId] || warning.courseId;
  doc.text('Course: ' + courseName, 14, 90);
  
  // Subject
  doc.setFont(undefined, 'bold');
  doc.text('Subject: Warning for Continuous Absenteeism', 14, 100);
  
  // Salutation
  doc.setFont(undefined, 'normal');
  doc.text('Dear ' + warning.name + ',', 14, 110);
  
  // Body - Professional warning letter
  doc.setFont(undefined, 'normal');
  const message = `This letter is to inform you that you have been absent continuously for ${warning.consecutiveAbsences} consecutive days from the ${courseName} course. Your current overall attendance stands at ${warning.attendancePercent}% (${warning.presentDays} present out of ${warning.totalDays} working days).

Regular and punctual attendance is mandatory for all students enrolled in Short Term Courses under MSBSVET. As per the course regulations, a minimum of 75% attendance is required for successful completion and certification.

Your continuous absence is affecting your learning progress and may result in serious consequences including:
  1. Ineligibility for final examination
  2. Non-issuance of course completion certificate
  3. Cancellation of course enrollment

This letter serves as a formal warning. You are hereby instructed to:
  ‚Ä¢ Report to the institute immediately
  ‚Ä¢ Provide valid reasons for your absence with supporting documents
  ‚Ä¢ Ensure regular attendance henceforth

Failure to comply with this notice may result in administrative action as per institute rules.`;
  
  const lines = doc.splitTextToSize(message, 180);
  doc.text(lines, 14, 120);
  
  // Absent Dates
  let yPos = 120 + (lines.length * 5) + 5;
  doc.setFont(undefined, 'bold');
  doc.text('Dates of Continuous Absence:', 14, yPos);
  doc.setFont(undefined, 'normal');
  doc.setTextColor(200, 0, 0);
  
  // Format dates nicely
  const formattedDates = warning.absentDates.map(d => {
    const date = new Date(d);
    return date.toLocaleDateString('en-GB');
  }).join(', ');
  
  const dateLines = doc.splitTextToSize(formattedDates, 180);
  doc.text(dateLines, 14, yPos + 6);
  doc.setTextColor(0, 0, 0);
  
  // Signatures
  yPos = yPos + (dateLines.length * 5) + 20;
  if (yPos > 250) yPos = 250; // Prevent overflow
  
  doc.setFont(undefined, 'normal');
  doc.text('For any queries, contact: Short Term Course Coordinator', 14, yPos);
  
  yPos += 15;
  doc.line(20, yPos, 70, yPos);
  doc.line(130, yPos, 190, yPos);
  
  yPos += 2;
  doc.setFont(undefined, 'bold');
  doc.setFontSize(10);
  doc.text('Short Term Course Coordinator', 22, yPos);
  doc.text('Deputy Director', 145, yPos);
  
  yPos += 5;
  doc.setFont(undefined, 'normal');
  doc.setFontSize(9);
  doc.text('Govt. ITI Nagpur', 30, yPos);
  doc.text('Govt. ITI Nagpur', 145, yPos);
  
  // Footer
  doc.setFont(undefined, 'italic');
  doc.setFontSize(8);
  doc.setTextColor(100, 100, 100);
  doc.text('This is a computer-generated document. Issued by Government ITI Nagpur', 105, 285, { align: 'center' });
  doc.text('Address: Shraddhanandpeth, Nagpur - 440022 | Phone: 8766987758', 105, 290, { align: 'center' });
  
  // Save
  doc.save('Warning_Letter_' + warning.studentId + '_' + today.replace(/\//g, '-') + '.pdf');
}

async function loadUsersForPasswordChange() {
  try {
    const data = await apiRequest('getAllUsers');
    
    if (data.success) {
      const select = document.getElementById('changePasswordUser');
      select.innerHTML = '<option value="">Select User</option>';
      
      data.users.forEach(user => {
        const option = document.createElement('option');
        option.value = user.userId;
        option.textContent = user.name + ' (' + user.role + ')';
        select.appendChild(option);
      });
    }
  } catch (error) {
    console.error('Load users error:', error);
    showToast('Failed to load users', 'error');
  }
}

async function changePassword() {
  const permissions = ROLE_PERMISSIONS[currentUser.role];
  if (!permissions.canChangePasswords) {
    showToast('Access denied', 'error');
    return;
  }
  
  const userId = document.getElementById('changePasswordUser').value;
  const newPassword = document.getElementById('newPassword').value;
  
  if (!userId || !newPassword) {
    showToast('Please select user and enter new password', 'error');
    return;
  }
  
  try {
    const data = await apiRequest('changePassword', {
      userId: userId,
      newPassword: newPassword
    });
    
    if (data.success) {
      showToast('Password changed successfully!', 'success');
      document.getElementById('newPassword').value = '';
      document.getElementById('changePasswordUser').value = '';
    } else {
      showToast(data.error || 'Failed to change password', 'error');
    }
  } catch (error) {
    console.error('Change password error:', error);
    showToast('Failed to change password: ' + error.message, 'error');
  }
}

function showToast(message, type) {
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  toast.textContent = message;
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s';
    setTimeout(() => toast.remove(), 300);
  }, 4000);
}

document.addEventListener('DOMContentLoaded', function() {
  const today = getTodayDate();
  const dateInputs = ['studentAttendanceDate', 'lessonPlanDate', 'reportStartDate', 'reportEndDate'];
  
  dateInputs.forEach(inputId => {
    const input = document.getElementById(inputId);
    if (input) {
      input.setAttribute('max', today);
      if (inputId === 'studentAttendanceDate' || inputId === 'lessonPlanDate') {
        input.value = today;
      }
    }
  });
  
  loadLogosForPDF();
});
</script>
</body>
</html>